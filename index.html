<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biomechanics Exam</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX compilation -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        /* Print Styles */
        @media print {
            @page { margin: 0.5in; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .break-inside-avoid { page-break-inside: avoid; }
            input, select, textarea { border: none !important; background: transparent !important; padding: 0 !important; }
            /* Hide empty inputs in print to look cleaner */
            input:placeholder-shown { display: none; }
            /* Ensure checkboxes appear in print */
            input[type="checkbox"] { appearance: auto; -webkit-appearance: checkbox; display: inline-block; }
            /* Hide scrollbars */
            ::-webkit-scrollbar { display: none; }
        }
        /* iOS input styling fixes */
        input, select, textarea { font-size: 16px; } 
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-slate-900">
    <div id="root" class="min-h-screen flex items-center justify-center text-gray-500">
        <!-- Loading State -->
        <div class="animate-pulse">Loading App...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURATION: TEST THRESHOLDS ---
        // Adjust these values to change when a finding is flagged in the Problem List
        const THRESHOLDS = {
            hip_flex: 110,      // Degrees
            hip_ir: 30,         // Degrees
            hip_er: 40,         // Degrees
            df_prom_kb: 20,     // Degrees
            ff_abd_max_df: 10,  // Degrees
            neck_flexion: 45,   // Degrees
            neck_extension: 45, // Degrees
            neck_rotation: 70,  // Degrees (Right/Left)
            ue_er_90: 90,       // Degrees
            ue_fwd_flex: 160    // Degrees
        };

        // --- Internal Icons ---
        const Icons = {
            'chevron-down': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>,
            'chevron-up': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>,
            'check': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            'activity': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
            'user': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            'clipboard-list': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>,
            'printer': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>,
            'file-text': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            'edit-3': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>,
            'alert-triangle': <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        };

        const Icon = ({ name, size = 20, className }) => {
            if (!Icons[name]) return null;
            return React.cloneElement(Icons[name], { width: size, height: size, className });
        };

        // --- Components ---

        const SectionHeader = ({ title, iconName, isOpen, toggle }) => (
            <div 
                onClick={toggle}
                className="flex items-center justify-between bg-slate-800 text-white p-4 rounded-t-lg cursor-pointer hover:bg-slate-700 transition-colors mt-6 no-print shadow-md"
            >
                <div className="flex items-center gap-2">
                    <Icon name={iconName} className="text-blue-300" />
                    <h2 className="font-bold text-lg">{title}</h2>
                </div>
                <Icon name={isOpen ? "chevron-up" : "chevron-down"} />
            </div>
        );

        const QualifiedCheckboxGroup = ({ label, name, options, data, onChange }) => {
            const currentSelection = data[name] || [];
            
            const handleSeverity = (option, severity) => {
                const safeOpt = option.replace(/\s+/g, '_');
                onChange(`${name}_${safeOpt}_severity`, severity);
            };

            return (
                <div className="mb-4">
                    {label && <label className="block text-sm font-semibold text-gray-700 mb-2">{label}</label>}
                    <div className="flex flex-col gap-2">
                        {options.map((opt) => {
                            const isSelected = currentSelection.includes(opt);
                            const safeOpt = opt.replace(/\s+/g, '_');
                            const currentSev = data[`${name}_${safeOpt}_severity`];
                            const showQualifiers = isSelected && !['Neutral', 'Level', 'Symmetrical', 'WFL', 'No Lateral Shift'].includes(opt);

                            return (
                                <div key={opt} className="flex flex-col sm:flex-row sm:items-center gap-2">
                                    <label className={`
                                        flex items-center gap-2 px-3 py-2 rounded-md border cursor-pointer transition-all text-sm select-none w-full sm:w-auto
                                        ${isSelected 
                                        ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium shadow-sm' 
                                        : 'bg-white border-gray-200 hover:border-blue-300 text-gray-600'}
                                    `}>
                                        <input
                                            type="checkbox"
                                            className="hidden"
                                            checked={isSelected}
                                            onChange={(e) => {
                                                const updated = e.target.checked
                                                    ? [...currentSelection, opt]
                                                    : currentSelection.filter((item) => item !== opt);
                                                onChange(name, updated);
                                                if (!e.target.checked) onChange(`${name}_${safeOpt}_severity`, '');
                                            }}
                                        />
                                        <div className={`w-4 h-4 rounded border flex items-center justify-center ${isSelected ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                                            {isSelected && <Icon name="check" size={12} className="text-white" />}
                                        </div>
                                        {opt}
                                    </label>

                                    {showQualifiers && (
                                        <div className="flex gap-1 ml-6 sm:ml-0 animate-fade-in">
                                            {['Mild', 'Mod', 'Sig'].map(sev => (
                                                <label key={sev} className={`
                                                    flex items-center justify-center text-[10px] cursor-pointer px-2 py-1 border rounded transition-colors uppercase
                                                    ${currentSev === sev 
                                                        ? 'bg-indigo-600 text-white border-indigo-600 shadow-sm' 
                                                        : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}
                                                `}>
                                                    <input 
                                                        type="radio" 
                                                        name={`${name}_${safeOpt}_sev_group`}
                                                        className="hidden"
                                                        checked={currentSev === sev}
                                                        onChange={() => handleSeverity(opt, sev)}
                                                    />
                                                    {sev}
                                                </label>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const CheckboxGroup = ({ label, name, options, data, onChange }) => (
            <div className="mb-4">
                <label className="block text-sm font-semibold text-gray-700 mb-2">{label}</label>
                <div className="flex flex-wrap gap-2">
                {options.map((opt) => (
                    <label 
                    key={opt} 
                    className={`
                        flex items-center gap-2 px-3 py-2 rounded-md border cursor-pointer transition-all text-sm select-none
                        ${(data[name] || []).includes(opt) 
                        ? 'bg-blue-100 border-blue-500 text-blue-800 font-medium shadow-sm' 
                        : 'bg-white border-gray-200 hover:border-blue-300 text-gray-600'}
                    `}
                    >
                    <input
                        type="checkbox"
                        className="hidden"
                        checked={(data[name] || []).includes(opt)}
                        onChange={(e) => {
                        const current = data[name] || [];
                        let updated;
                        // Default behavior: toggle
                        updated = e.target.checked
                            ? [...current, opt]
                            : current.filter((item) => item !== opt);
                        onChange(name, updated);
                        }}
                    />
                    <div className={`w-4 h-4 rounded border flex items-center justify-center ${(data[name] || []).includes(opt) ? 'bg-blue-500 border-blue-500' : 'border-gray-300'}`}>
                        {(data[name] || []).includes(opt) && <Icon name="check" size={12} className="text-white" />}
                    </div>
                    {opt}
                    </label>
                ))}
                </div>
            </div>
        );

        const GaitObservationRow = ({ label, name, data, onChange }) => (
            <div className="mb-4 p-3 bg-gray-50 rounded border border-gray-100">
                <label className="block text-sm font-bold text-gray-700 mb-1">{label}</label>
                <input
                    type="text"
                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none transition-all mb-2"
                    placeholder="Notes..."
                    value={data[name] || ''}
                    onChange={(e) => onChange(name, e.target.value)}
                />
                <div className="flex gap-2">
                    {['Mild', 'Mod', 'Sig'].map(sev => (
                        <label key={sev} className={`
                            flex-1 flex items-center justify-center text-xs cursor-pointer px-2 py-1 border rounded transition-colors text-center
                            ${data[`${name}_severity`] === sev 
                                ? 'bg-blue-600 text-white border-blue-600' 
                                : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-100'}
                        `}>
                            <input 
                                type="radio" 
                                className="hidden"
                                checked={data[`${name}_severity`] === sev}
                                onChange={() => onChange(`${name}_severity`, data[`${name}_severity`] === sev ? '' : sev)}
                            />
                            {sev}
                        </label>
                    ))}
                </div>
            </div>
        );

        const WFLCheckbox = ({ checked, onChange, label = "WFL" }) => (
            <label className={`flex items-center gap-1 cursor-pointer px-2 py-2 rounded border transition-colors select-none ${checked ? 'bg-green-100 border-green-300' : 'bg-gray-50 border-gray-200 hover:bg-gray-100'}`}>
                <input 
                    type="checkbox" 
                    checked={checked || false}
                    onChange={(e) => onChange(e.target.checked)}
                    className="hidden"
                />
                <div className={`w-3 h-3 rounded-full border flex items-center justify-center ${checked ? 'bg-green-600 border-green-600' : 'border-gray-400'}`}>
                    {checked && <Icon name="check" size={10} className="text-white" />}
                </div>
                <span className={`text-[10px] font-bold ${checked ? 'text-green-700' : 'text-gray-400'}`}>{label}</span>
            </label>
        );

        const InputRow = ({ label, name, data, onChange, placeholder = "Notes..." }) => (
            <div className="mb-3 grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                <label className="text-sm font-medium text-gray-700 md:col-span-1">{label}</label>
                <input
                type="text"
                className="md:col-span-2 w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                placeholder={placeholder}
                value={data[name] || ''}
                onChange={(e) => onChange(name, e.target.value)}
                />
            </div>
        );

        const SingleInputRow = ({ label, baseName, data, onChange, placeholder = "deg", showWFL = false, suffix = "Degrees" }) => (
            <div className="mb-3 flex flex-col md:flex-row gap-2 items-center border-b border-gray-100 pb-2 md:pb-0 md:border-0">
                <div className="md:w-1/4">
                    <label className="text-sm font-medium text-gray-700">{label}</label>
                </div>
                <div className="md:w-3/4 flex items-center gap-2">
                    <div className="flex-1 relative">
                        <input
                            type="text"
                            className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none pr-16"
                            placeholder="0"
                            value={data[baseName] || ''}
                            onChange={(e) => onChange(baseName, e.target.value)}
                        />
                        <span className="absolute right-3 top-2.5 text-xs text-gray-400 pointer-events-none">{suffix}</span>
                    </div>
                    {showWFL && (
                        <WFLCheckbox 
                            checked={data[`${baseName}_wfl`]} 
                            onChange={(val) => onChange(`${baseName}_wfl`, val)} 
                        />
                    )}
                </div>
            </div>
        );

        const DualInputRow = ({ label, baseName, data, onChange, leftLabel = "Left", rightLabel = "Right", placeholder="", showWFL = false, suffix = "" }) => (
            <div className="mb-3 flex flex-col md:flex-row gap-2 items-center border-b border-gray-100 pb-2 md:pb-0 md:border-0">
                <div className="md:w-1/4">
                    <label className="text-sm font-medium text-gray-700">{label}</label>
                </div>
                
                <div className="md:w-3/4 flex items-center gap-2">
                    <div className="flex-1 flex items-center gap-2 relative">
                        <span className="text-xs text-gray-400 font-mono w-3">{rightLabel.charAt(0)}</span>
                        <div className="relative w-full">
                            <input
                                type="text"
                                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder={rightLabel}
                                value={data[`${baseName}_R`] || ''}
                                onChange={(e) => onChange(`${baseName}_R`, e.target.value)}
                            />
                            {suffix && <span className="absolute right-2 top-2.5 text-xs text-gray-400 pointer-events-none">{suffix}</span>}
                        </div>
                        {showWFL && <WFLCheckbox checked={data[`${baseName}_R_wfl`]} onChange={(val) => onChange(`${baseName}_R_wfl`, val)} />}
                    </div>

                    <div className="flex-1 flex items-center gap-2 relative">
                        <span className="text-xs text-gray-400 font-mono w-3">{leftLabel.charAt(0)}</span>
                        <div className="relative w-full">
                            <input
                                type="text"
                                className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                                placeholder={leftLabel}
                                value={data[`${baseName}_L`] || ''}
                                onChange={(e) => onChange(`${baseName}_L`, e.target.value)}
                            />
                            {suffix && <span className="absolute right-2 top-2.5 text-xs text-gray-400 pointer-events-none">{suffix}</span>}
                        </div>
                        {showWFL && <WFLCheckbox checked={data[`${baseName}_L_wfl`]} onChange={(val) => onChange(`${baseName}_L_wfl`, val)} />}
                    </div>
                </div>
            </div>
        );

        const DualDropdownRow = ({ label, baseName, data, onChange, leftLabel = "Left", rightLabel = "Right", showWFL = false, customOptions = null }) => {
            const grades = customOptions || ['5/5', '+4/5', '4/5', '-4/5', '3+/5', '3/5', '-3/5', '+2/5', '2/5', '-2/5'];
            return (
            <div className="mb-3 flex flex-col md:flex-row gap-2 items-center border-b border-gray-100 pb-2 md:pb-0 md:border-0">
                <div className="md:w-1/4">
                    <label className="text-sm font-medium text-gray-700">{label}</label>
                </div>
                
                <div className="md:w-3/4 flex items-center gap-2">
                    <div className="flex-1 flex items-center gap-2">
                        <span className="text-xs text-gray-400 font-mono w-3">{rightLabel.charAt(0)}</span>
                        <select
                            className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                            value={data[`${baseName}_R`] || ''}
                            onChange={(e) => onChange(`${baseName}_R`, e.target.value)}
                        >
                            <option value="">Select...</option>
                            {grades.map(g => <option key={g} value={g}>{g}</option>)}
                        </select>
                        {showWFL && <WFLCheckbox checked={data[`${baseName}_R_wfl`]} onChange={(val) => onChange(`${baseName}_R_wfl`, val)} />}
                    </div>
            
                    <div className="flex-1 flex items-center gap-2">
                        <span className="text-xs text-gray-400 font-mono w-3">{leftLabel.charAt(0)}</span>
                        <select
                            className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none bg-white"
                            value={data[`${baseName}_L`] || ''}
                            onChange={(e) => onChange(`${baseName}_L`, e.target.value)}
                        >
                            <option value="">Select...</option>
                            {grades.map(g => <option key={g} value={g}>{g}</option>)}
                        </select>
                        {showWFL && <WFLCheckbox checked={data[`${baseName}_L_wfl`]} onChange={(val) => onChange(`${baseName}_L_wfl`, val)} />}
                    </div>
                </div>
            </div>
            );
        };

        const DualBinaryRow = ({ label, baseName, data, onChange }) => {
            return (
                <div className="mb-3 flex flex-col md:flex-row gap-2 items-center border-b border-gray-100 pb-2 md:pb-0 md:border-0">
                    <div className="md:w-1/4">
                        <label className="text-sm font-medium text-gray-700">{label}</label>
                    </div>
                    <div className="md:w-3/4 flex items-center gap-4">
                        <div className="flex-1 flex items-center gap-2 border-r border-gray-100 pr-2">
                            <span className="text-xs text-gray-400 font-mono">R:</span>
                            <label className="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" checked={data[`${baseName}_R`] === 'Pos'} onChange={() => onChange(`${baseName}_R`, data[`${baseName}_R`] === 'Pos' ? '' : 'Pos')} className="w-4 h-4 text-red-500 rounded focus:ring-red-500" />
                                <span className="text-xs text-gray-600">Pos</span>
                            </label>
                            <label className="flex items-center gap-1 cursor-pointer ml-2">
                                <input type="checkbox" checked={data[`${baseName}_R`] === 'Neg'} onChange={() => onChange(`${baseName}_R`, data[`${baseName}_R`] === 'Neg' ? '' : 'Neg')} className="w-4 h-4 text-blue-500 rounded focus:ring-blue-500" />
                                <span className="text-xs text-gray-600">Neg</span>
                            </label>
                        </div>
                        <div className="flex-1 flex items-center gap-2">
                            <span className="text-xs text-gray-400 font-mono">L:</span>
                            <label className="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" checked={data[`${baseName}_L`] === 'Pos'} onChange={() => onChange(`${baseName}_L`, data[`${baseName}_L`] === 'Pos' ? '' : 'Pos')} className="w-4 h-4 text-red-500 rounded focus:ring-red-500" />
                                <span className="text-xs text-gray-600">Pos</span>
                            </label>
                            <label className="flex items-center gap-1 cursor-pointer ml-2">
                                <input type="checkbox" checked={data[`${baseName}_L`] === 'Neg'} onChange={() => onChange(`${baseName}_L`, data[`${baseName}_L`] === 'Neg' ? '' : 'Neg')} className="w-4 h-4 text-blue-500 rounded focus:ring-blue-500" />
                                <span className="text-xs text-gray-600">Neg</span>
                            </label>
                        </div>
                    </div>
                </div>
            )
        }

        const DualMobilityRow = ({ label, baseName, data, onChange }) => {
            const qualities = ['WFL', 'Mild Stiff', 'Mod. Stiff', 'Sig. Stiff'];
            const renderOptions = (side) => (
                <div className="flex gap-1 flex-wrap">
                    {qualities.map(q => {
                    const display = q.replace(' Stiff', '');
                    return (
                        <label key={q} className={`
                            flex items-center justify-center text-[10px] cursor-pointer px-2 py-1 border rounded transition-colors select-none
                            ${data[`${baseName}_${side}`] === q 
                                ? 'bg-blue-100 border-blue-400 text-blue-900 font-bold' 
                                : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}
                        `}>
                            <input 
                                type="radio" 
                                className="hidden" 
                                checked={data[`${baseName}_${side}`] === q} 
                                onChange={() => onChange(`${baseName}_${side}`, q)} 
                            />
                            {display}
                        </label>
                    )
                    })}
                </div>
            );
            return (
                <div className="mb-4 pb-2 border-b border-gray-50 last:border-0">
                    <div className="text-sm font-bold text-gray-700 mb-2">{label} Joint Mobility Restriction</div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div className="flex items-center gap-2"><span className="text-xs font-mono text-gray-400 w-4">R:</span>{renderOptions('R')}</div>
                        <div className="flex items-center gap-2"><span className="text-xs font-mono text-gray-400 w-4">L:</span>{renderOptions('L')}</div>
                    </div>
                </div>
            );
        }

        const ForefootRow = ({ label, side, data, onChange }) => {
            const orientationKey = `forefoot_${side}_orientation`;
            const severityKey = `forefoot_${side}_severity`;
            const orientation = data[orientationKey];
            const severity = data[severityKey];

            return (
                <div className="mb-4 bg-gray-50 p-2 rounded border border-gray-100">
                <div className="flex items-center gap-2 mb-2">
                    <span className="font-bold text-sm text-gray-700 w-16 uppercase tracking-wide">{label}</span>
                    <div className="flex gap-1">
                        {['Neutral', 'Varus', 'Valgus'].map(opt => (
                            <label key={opt} className={`
                                flex items-center justify-center text-xs cursor-pointer px-3 py-1 border rounded transition-colors select-none
                                ${orientation === opt ? 'bg-blue-600 border-blue-600 text-white font-medium shadow-sm' : 'bg-white border-gray-300 text-gray-600 hover:border-blue-300'}
                            `}>
                                <input type="radio" className="hidden" checked={orientation === opt} onChange={() => onChange(orientationKey, opt)} />
                                {opt}
                            </label>
                        ))}
                    </div>
                </div>
                {(orientation === 'Varus' || orientation === 'Valgus') && (
                    <div className="flex items-center gap-2 ml-16 pl-2 border-l-2 border-blue-200">
                        <span className="text-xs text-blue-800 font-semibold mr-1">Severity:</span>
                        {['Mild', 'Mod', 'Sig'].map(sev => (
                            <label key={sev} className={`
                            flex items-center justify-center text-[10px] uppercase cursor-pointer px-2 py-1 border rounded transition-colors select-none
                            ${severity === sev ? 'bg-blue-100 border-blue-400 text-blue-900 font-bold' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}
                            `}>
                            <input type="radio" className="hidden" checked={severity === sev} onChange={() => onChange(severityKey, sev)} />
                            {sev}
                            </label>
                        ))}
                    </div>
                )}
                </div>
            )
        }

        const ToeTouchRow = ({ label, name, data, onChange }) => (
            <div className="grid grid-cols-5 gap-1 md:gap-2 items-center mb-2 border-b border-gray-50 pb-2 last:border-0">
                <div className="col-span-1 text-sm font-bold text-gray-700">{label}</div>
                {['WFL', 'Mild Flexion', 'Mod Flexion', 'Sig Flexion'].map(opt => (
                    <label key={opt} className={`col-span-1 flex flex-col items-center justify-center text-[10px] md:text-xs text-center cursor-pointer p-1 border rounded hover:bg-gray-50 transition-colors select-none ${data[name] === opt ? 'bg-blue-100 border-blue-400 text-blue-900 font-bold' : 'bg-white border-gray-200 text-gray-500'}`}>
                        <input type="radio" name={name} checked={data[name] === opt} onChange={() => onChange(name, opt)} className="mb-1 w-3 h-3" />
                        <span className="leading-tight">{opt.replace(' Flexion', '')}</span>
                    </label>
                ))}
            </div>
        );

        const MyotomeRow = ({ level, label, data, onChange }) => {
            const grades = ['5/5', '+4/5', '4/5', '-4/5', '3+/5', '3/5', '-3/5', '+2/5', '2/5', '-2/5'];
            return (
                <div className="grid grid-cols-12 gap-2 items-center mb-2 border-b border-gray-100 pb-2 last:border-0">
                    <div className="col-span-2 font-bold text-gray-700 text-center bg-gray-100 rounded py-1">{level}</div>
                    <div className="col-span-5">
                        <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white" value={data[`myotome_${level}_R`] || ''} onChange={(e) => onChange(`myotome_${level}_R`, e.target.value)}>
                            <option value="">Right...</option>
                            {grades.map(g => <option key={g} value={g}>{g}</option>)}
                        </select>
                    </div>
                    <div className="col-span-5">
                        <select className="w-full p-2 border border-gray-300 rounded text-sm bg-white" value={data[`myotome_${level}_L`] || ''} onChange={(e) => onChange(`myotome_${level}_L`, e.target.value)}>
                            <option value="">Left...</option>
                            {grades.map(g => <option key={g} value={g}>{g}</option>)}
                        </select>
                    </div>
                </div>
            );
        }

        // --- Read Only Components ---

        const ReadOnlyField = ({ label, value, data, sectionName }) => {
            if (!value || (Array.isArray(value) && value.length === 0)) return null;
            
            const renderValue = (val) => {
                if (typeof val !== 'string') return val;
                const safeOpt = val.replace(/\s+/g, '_');
                const severity = data[`${sectionName}_${safeOpt}_severity`];
                return severity ? `${val} (${severity})` : val;
            };

            return (
            <div className="mb-2 break-inside-avoid">
                <span className="font-semibold text-gray-800 text-sm">{label}: </span>
                <span className="text-gray-900 text-sm ml-1">
                {Array.isArray(value) ? value.map(renderValue).join(', ') : renderValue(value)}
                </span>
            </div>
            );
        };

        const ReadOnlyGait = ({ label, val, sev }) => {
            if(!val) return null;
            return (
                <div className="mb-2 text-sm">
                    <span className="font-semibold text-gray-700">{label}: </span>
                    <span className="text-gray-900">{val}</span>
                    {sev && <span className="ml-2 text-xs text-white bg-blue-600 px-1.5 py-0.5 rounded">{sev}</span>}
                </div>
            )
        }

        const ReadOnlySingle = ({ label, val, wfl, suffix }) => {
            if(!val && !wfl) return null;
            return (
                <div className="mb-2 grid grid-cols-6 gap-2 text-sm border-b border-gray-100 pb-1 break-inside-avoid items-center">
                    <div className="col-span-2 font-semibold text-gray-800 flex items-center gap-2">{label}</div>
                    <div className="col-span-4 flex items-center gap-2">
                        {val} {val && suffix && <span className="text-xs text-gray-500">{suffix}</span>}
                        {wfl && <span className="text-[9px] bg-green-100 text-green-800 px-1 rounded border border-green-200">WFL</span>}
                    </div>
                </div>
            )
        }

        const ReadOnlyDual = ({ label, rVal, lVal, rWfl, lWfl, suffix }) => {
            if (!rVal && !lVal && !rWfl && !lWfl) return null;
            return (
            <div className="mb-2 grid grid-cols-6 gap-2 text-sm border-b border-gray-100 pb-1 break-inside-avoid items-center">
                <div className="col-span-2 font-semibold text-gray-800 flex items-center gap-2">
                    {label}
                </div>
                <div className="col-span-2 flex items-center gap-1">
                    <span className="text-gray-500 text-xs mr-1">R:</span>
                    {rVal || '-'} {rVal && suffix && <span className="text-[9px] text-gray-400">{suffix}</span>}
                    {rWfl && <span className="text-[9px] bg-green-100 text-green-800 px-1 rounded border border-green-200 ml-1">WFL</span>}
                </div>
                <div className="col-span-2 flex items-center gap-1">
                    <span className="text-gray-500 text-xs mr-1">L:</span>
                    {lVal || '-'} {lVal && suffix && <span className="text-[9px] text-gray-400">{suffix}</span>}
                    {lWfl && <span className="text-[9px] bg-green-100 text-green-800 px-1 rounded border border-green-200 ml-1">WFL</span>}
                </div>
            </div>
            );
        };

        const ReadOnlyToeTouch = ({ thoracic, lumbar, sacrum }) => {
            if(!thoracic && !lumbar && !sacrum) return null;
            return (
                <div className="mb-4 text-sm border border-gray-200 rounded p-2 break-inside-avoid">
                    <div className="font-bold text-gray-700 mb-2 border-b pb-1">Toe Touch Grading</div>
                    <div className="grid grid-cols-2 gap-y-1">
                        <div className="font-medium text-gray-600">Thoracic:</div><div>{thoracic || '-'}</div>
                        <div className="font-medium text-gray-600">Lumbar:</div><div>{lumbar || '-'}</div>
                        <div className="font-medium text-gray-600">Sacrum:</div><div>{sacrum || '-'}</div>
                    </div>
                </div>
            )
        }

        const ReadOnlyForefoot = ({ rOri, rSev, lOri, lSev }) => {
            if(!rOri && !lOri) return null;
            const format = (ori, sev) => {
                if (!ori) return '-';
                if (ori === 'Neutral') return 'Neutral';
                return `${ori} (${sev || ''})`;
            }
            return (
                <div className="mb-3 break-inside-avoid">
                    <div className="font-semibold text-gray-800 text-sm mb-1">Forefoot Orientation</div>
                    <div className="grid grid-cols-6 gap-2 text-sm">
                        <div className="col-span-2 text-gray-500 text-xs">Result:</div>
                        <div className="col-span-2"><span className="text-gray-500 text-xs mr-1">R:</span>{format(rOri, rSev)}</div>
                        <div className="col-span-2"><span className="text-gray-500 text-xs mr-1">L:</span>{format(lOri, lSev)}</div>
                    </div>
                </div>
            )
        }

        const ReadOnlyMobility = ({ label, r, l }) => {
            if (!r && !l) return null;
            return (
                <div className="mb-2 text-sm grid grid-cols-12 gap-1 break-inside-avoid">
                    <div className="col-span-4 font-semibold text-gray-700">{label} Joint Mobility Restriction</div>
                    <div className="col-span-4 text-xs"><span className="text-gray-400">R:</span> {r}</div>
                    <div className="col-span-4 text-xs"><span className="text-gray-400">L:</span> {l}</div>
                </div>
            )
        }

        const ProblemList = ({ data }) => {
            const problems = [];

            // 1. Posture
            const checkPosture = (field, label) => {
                (data[field] || []).forEach(opt => {
                    if(!['Neutral', 'Level', 'Symmetrical', 'WFL'].includes(opt)) {
                        const sev = data[`${field}_${opt.replace(/\s+/g, '_')}_severity`];
                        problems.push(`Posture: ${label} - ${opt} ${sev ? `(${sev})` : ''}`);
                    }
                });
            };
            checkPosture('head_posture', 'Head');
            checkPosture('thoracic_posture', 'Thoracic');
            checkPosture('scapula_posture', 'Scapula');
            checkPosture('lateral_shift', 'Lateral Shift');
            checkPosture('lumbar_posture', 'Lumbar');
            checkPosture('asis_position', 'ASIS');
            checkPosture('psis_position', 'PSIS');
            checkPosture('knees_posture_R', 'Right Knee');
            checkPosture('knees_posture_L', 'Left Knee');
            checkPosture('arch_posture_R', 'Right Arch');
            checkPosture('arch_posture_L', 'Left Arch');

            // 2. Knee Drive
            (data.knee_drive || []).forEach(k => problems.push(`Dynamic: ${k}`));

            // 3. Gait
            ['trunk', 'arm', 'antalgic', 'crossover', 'pelvic', 'knee'].forEach(k => {
                const val = data[`gait_${k}`];
                const sev = data[`gait_${k}_severity`];
                if(val) problems.push(`Gait: ${val} ${sev ? `(${sev})` : ''}`);
            });

            // 4. Neuro
            ['L2','L3','L4','L5','S1'].forEach(lvl => {
                if(data[`myotome_${lvl}_R`] && data[`myotome_${lvl}_R`] !== '5/5') problems.push(`Weakness: ${lvl} Right (${data[`myotome_${lvl}_R`]})`);
                if(data[`myotome_${lvl}_L`] && data[`myotome_${lvl}_L`] !== '5/5') problems.push(`Weakness: ${lvl} Left (${data[`myotome_${lvl}_L`]})`);
            });
            if(data.neuro_intact_except) problems.push(`Neuro: ${data.neuro_notes}`);

            // 5. Special Tests
            const checkPos = (base, label) => {
                if(data[`${base}_R`] === 'Pos') problems.push(`Positive ${label} (Right)`);
                if(data[`${base}_L`] === 'Pos') problems.push(`Positive ${label} (Left)`);
            }
            checkPos('hip_logroll', 'Hip Log Roll');
            checkPos('ober', 'Ober Test');
            checkPos('thomas', 'Thomas Test');
            checkPos('hip_quadrant', 'Hip Quadrant Test'); // Added Hip Quadrant Test

            // 6. Mobility (Hip/Foot)
            const checkMobility = (val, label, side) => {
                if(val && val !== 'WFL') problems.push(`${label} ${side}: ${val}`);
            }
            // ... Hip mobility specific fields? (Prone Quad)
            checkMobility(data.prone_quad_R, 'Prone Quad Flex', 'Right');
            checkMobility(data.prone_quad_L, 'Prone Quad Flex', 'Left');
            
            // Foot Mobility
            const footMobs = [
                ['mobility_calc_cuboid', 'Calcaneal-Cuboid'],
                ['mobility_pf_abd', 'Plantar Flex + ABD'],
                ['mobility_45_meta_df', '4th/5th Meta DF'],
                ['mobility_1st_mtp_ext', '1st MTP Ext']
            ];
            footMobs.forEach(([base, label]) => {
                checkMobility(data[`${base}_R`], label, 'Right');
                checkMobility(data[`${base}_L`], label, 'Left');
            });

            // 7. ROM Checks (Thresholds)
            const checkROM = (val, threshold, label, side = '') => {
                if(!val) return;
                const num = parseInt(val);
                if(!isNaN(num) && num < threshold) {
                    problems.push(`Limited ROM: ${label} ${side} (${val}°) < ${threshold}°`);
                }
            }
            // Hip
            checkROM(data.hip_flex_R, THRESHOLDS.hip_flex, 'Hip Flexion', 'Right');
            checkROM(data.hip_flex_L, THRESHOLDS.hip_flex, 'Hip Flexion', 'Left');
            checkROM(data.hip_ir_R, THRESHOLDS.hip_ir, 'Hip IR', 'Right');
            checkROM(data.hip_ir_L, THRESHOLDS.hip_ir, 'Hip IR', 'Left');
            checkROM(data.hip_er_R, THRESHOLDS.hip_er, 'Hip ER', 'Right');
            checkROM(data.hip_er_L, THRESHOLDS.hip_er, 'Hip ER', 'Left');
            // Ankle
            checkROM(data.df_prom_kb_R, THRESHOLDS.df_prom_kb, 'DF (Knee Bent)', 'Right');
            checkROM(data.df_prom_kb_L, THRESHOLDS.df_prom_kb, 'DF (Knee Bent)', 'Left');
            checkROM(data.ff_abd_max_df_R, THRESHOLDS.ff_abd_max_df, 'FF ABD', 'Right');
            checkROM(data.ff_abd_max_df_L, THRESHOLDS.ff_abd_max_df, 'FF ABD', 'Left');
            // Neck
            checkROM(data.neck_flexion, THRESHOLDS.neck_flexion, 'Cervical Flexion');
            checkROM(data.neck_extension, THRESHOLDS.neck_extension, 'Cervical Extension');
            checkROM(data.neck_r_rotation, THRESHOLDS.neck_rotation, 'Cervical Rot Right');
            checkROM(data.neck_l_rotation, THRESHOLDS.neck_rotation, 'Cervical Rot Left');
            // Shoulder
            checkROM(data.ue_er_90_R, THRESHOLDS.ue_er_90, 'Shoulder ER', 'Right');
            checkROM(data.ue_er_90_L, THRESHOLDS.ue_er_90, 'Shoulder ER', 'Left');
            checkROM(data.ue_fwd_flex_R, THRESHOLDS.ue_fwd_flex, 'Shoulder Flex', 'Right');
            checkROM(data.ue_fwd_flex_L, THRESHOLDS.ue_fwd_flex, 'Shoulder Flex', 'Left');

            // 8. Strength
            const checkStr = (base, label) => {
                if(data[`${base}_R`] && data[`${base}_R`] !== '5/5') problems.push(`Weakness: ${label} Right (${data[`${base}_R`]})`);
                if(data[`${base}_L`] && data[`${base}_L`] !== '5/5') problems.push(`Weakness: ${label} Left (${data[`${base}_L`]})`);
            }
            checkStr('ham_str', 'Hamstrings');
            checkStr('hip_abd_str', 'Hip Abd');
            checkStr('ankle_df_str', 'Ankle DF');
            checkStr('ankle_ev_str', 'Ankle Eversion');
            checkStr('ankle_inv_str', 'Ankle Inversion');
            checkStr('ray_pf_str', '1st Ray PF');

            // 9. Leg Length
            if(data.leg_len_mm) {
                const side = data.leg_len_side_R ? 'Right' : (data.leg_len_side_L ? 'Left' : '');
                if(side) problems.push(`Leg Length Discrepancy: ${data.leg_len_mm}mm (${side} Long)`);
            }

            if(problems.length === 0) return null;

            return (
                <div className="mt-8 pt-6 border-t-4 border-red-100 break-inside-avoid">
                    <h3 className="font-bold text-xl text-red-800 mb-4 flex items-center gap-2">
                        <Icon name="alert-triangle" />
                        Summary of Abnormal Findings / Problem List
                    </h3>
                    <ul className="pl-2 space-y-1">
                        {problems.map((p, i) => (
                            <li key={i} className="flex items-start gap-2">
                                <input type="checkbox" className="mt-1" />
                                <span className="text-sm text-gray-800 font-medium">{p}</span>
                            </li>
                        ))}
                    </ul>
                </div>
            );
        };

        // --- Main App Logic ---

        const BiomechanicsExam = () => {
            const [mode, setMode] = useState('edit');
            const [expandedSections, setExpandedSections] = useState({
                client: true, posture: true, dynamic: true, neuro: true, mobility: true, foot: true, upper: true
            });

            const initialData = {
                date: new Date().toISOString().split('T')[0],
                initials: '',
                // Posture
                head_posture: [], thoracic_posture: [], scapula_posture: [], lumbar_posture: [],
                lateral_shift: [], asis_position: [], psis_position: [], pelvis_posture: [], 
                knees_posture_R: [], knees_posture_L: [], // Split Knees
                arch_posture_R: [], arch_posture_L: [],   // Split Arch
                // Dynamic
                knee_drive: [], knee_drive_right_active: false, knee_drive_left_active: false,
                gait_wfl: false,
                gait_trunk: '', gait_trunk_severity: '',
                gait_arm: '', gait_arm_severity: '',
                gait_antalgic: '', gait_antalgic_severity: '',
                gait_crossover: '', gait_crossover_severity: '',
                gait_pelvic: '', gait_pelvic_severity: '',
                gait_knee: '', gait_knee_severity: '',
                // Neuro
                neuro_all_intact: false, neuro_intact_except: false, neuro_notes: 'Intact except for the following: ',
                myotome_L2_R: '', myotome_L2_L: '', myotome_L3_R: '', myotome_L3_L: '',
                myotome_L4_R: '', myotome_L4_L: '', myotome_L5_R: '', myotome_L5_L: '', myotome_S1_R: '', myotome_S1_L: '',
                // Hip
                toe_touch_thoracic: '', toe_touch_lumbar: '', toe_touch_sacrum: '',
                hip_logroll_R: '', hip_logroll_L: '',
                hip_flex_R: '', hip_flex_L: '', hip_flex_R_wfl: false, hip_flex_L_wfl: false,
                hip_ir_R: '', hip_ir_L: '', hip_ir_R_wfl: false, hip_ir_L_wfl: false,
                hip_er_R: '', hip_er_L: '', hip_er_R_wfl: false, hip_er_L_wfl: false,
                ober_R: '', ober_L: '', thomas_R: '', thomas_L: '',
                hip_quadrant_R: '', hip_quadrant_L: '', // Added Hip Quadrant
                prone_quad_R: '', prone_quad_L: '',
                ham_str_R: '', ham_str_L: '', ham_str_R_wfl: false, ham_str_L_wfl: false,
                hip_abd_str_R: '', hip_abd_str_L: '', hip_abd_str_R_wfl: false, hip_abd_str_L_wfl: false,
                leg_len_mm: '', leg_len_side_R: false, leg_len_side_L: false, leg_len_sym: false,
                // Foot
                forefoot_R_orientation: 'Neutral', forefoot_R_severity: '', forefoot_L_orientation: 'Neutral', forefoot_L_severity: '',
                ankle_df_str_R: '', ankle_df_str_L: '', ankle_df_str_R_wfl: false, ankle_df_str_L_wfl: false,
                ankle_ev_str_R: '', ankle_ev_str_L: '', ankle_ev_str_R_wfl: false, ankle_ev_str_L_wfl: false,
                ankle_inv_str_R: '', ankle_inv_str_L: '', ankle_inv_str_R_wfl: false, ankle_inv_str_L_wfl: false,
                ray_pf_str_R: '', ray_pf_str_L: '', ray_pf_str_R_wfl: false, ray_pf_str_L_wfl: false,
                mobility_calc_cuboid_R: '', mobility_calc_cuboid_L: '', mobility_pf_abd_R: '', mobility_pf_abd_L: '',
                mobility_45_meta_df_R: '', mobility_45_meta_df_L: '', mobility_1st_mtp_ext_R: '', mobility_1st_mtp_ext_L: '',
                df_prom_kb_R: '', df_prom_kb_L: '', ff_abd_max_df_R: '', ff_abd_max_df_L: '',
                // Neck/Upper
                neck_flexion: '', neck_flexion_wfl: false, neck_extension: '', neck_extension_wfl: false,
                neck_r_rotation: '', neck_r_rotation_wfl: false, neck_l_rotation: '', neck_l_rotation_wfl: false,
                ue_er_90_R: '', ue_er_90_L: '', ue_er_90_R_wfl: false, ue_er_90_L_wfl: false,
                ue_fwd_flex_R: '', ue_fwd_flex_L: '', ue_fwd_flex_R_wfl: false, ue_fwd_flex_L_wfl: false,
            };

            const [formData, setFormData] = useState(initialData);

            useEffect(() => {
                const saved = localStorage.getItem('bioExamData');
                if (saved) {
                    try { setFormData(JSON.parse(saved)); } catch(e) { console.error('Load error', e); }
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('bioExamData', JSON.stringify(formData));
            }, [formData]);

            const handleChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const clearForm = () => {
                if(confirm("Are you sure you want to clear all data?")) {
                    setFormData(initialData);
                    setMode('edit');
                    window.scrollTo(0,0);
                }
            }

            const toggleSection = (sec) => {
                setExpandedSections(prev => ({ ...prev, [sec]: !prev[sec] }));
            };

            // --- VIEW: PREVIEW ---
            if (mode === 'preview') {
                return (
                    <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans">
                        <div className="max-w-4xl mx-auto bg-white shadow-xl min-h-[11in] p-8 md:p-12 print:shadow-none print:p-0">
                            
                            {/* Header */}
                            <div className="flex justify-between items-end border-b-4 border-slate-800 pb-4 mb-8">
                                <div>
                                    <h1 className="text-3xl font-bold text-slate-800 uppercase tracking-tight">Biomechanics Exam</h1>
                                    <p className="text-slate-500 text-sm mt-1">Physical Examination Client Record</p>
                                </div>
                                <div className="text-right">
                                    <p className="font-medium">Date: {formData.date}</p>
                                    <p className="font-medium">Initials: {formData.initials}</p>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 print:block">
                                {/* Column 1 */}
                                <div>
                                    <h3 className="font-bold text-lg text-blue-800 mb-3 border-b border-blue-200 pb-1 uppercase text-xs tracking-wider">Static Observation</h3>
                                    <ReadOnlyField label="Head" value={formData.head_posture} data={formData} sectionName="head_posture" />
                                    <ReadOnlyField label="Thoracic" value={formData.thoracic_posture} data={formData} sectionName="thoracic_posture" />
                                    <ReadOnlyField label="Scapula" value={formData.scapula_posture} data={formData} sectionName="scapula_posture" />
                                    <ReadOnlyField label="Lateral Shift" value={formData.lateral_shift} data={formData} sectionName="lateral_shift" />
                                    <ReadOnlyField label="Lumbar" value={formData.lumbar_posture} data={formData} sectionName="lumbar_posture" />
                                    <div className="my-2 border-t border-dashed border-gray-200"></div>
                                    <ReadOnlyField label="ASIS" value={formData.asis_position} data={formData} sectionName="asis_position" />
                                    <ReadOnlyField label="PSIS" value={formData.psis_position} data={formData} sectionName="psis_position" />
                                    <div className="my-2 border-t border-dashed border-gray-200"></div>
                                    {/* Split Knees/Arch for preview */}
                                    <div className="mb-2 text-sm">
                                        <div className="font-semibold text-gray-800">Knees:</div>
                                        <div className="ml-2 grid grid-cols-2 gap-4">
                                            <div><span className="text-gray-500 text-xs">R:</span> <span className="text-gray-900">{(formData.knees_posture_R || []).join(', ') || '-'}</span></div>
                                            <div><span className="text-gray-500 text-xs">L:</span> <span className="text-gray-900">{(formData.knees_posture_L || []).join(', ') || '-'}</span></div>
                                        </div>
                                    </div>
                                    <div className="mb-2 text-sm">
                                        <div className="font-semibold text-gray-800">Feet/Arch:</div>
                                        <div className="ml-2 grid grid-cols-2 gap-4">
                                            <div><span className="text-gray-500 text-xs">R:</span> <span className="text-gray-900">{(formData.arch_posture_R || []).join(', ') || '-'}</span></div>
                                            <div><span className="text-gray-500 text-xs">L:</span> <span className="text-gray-900">{(formData.arch_posture_L || []).join(', ') || '-'}</span></div>
                                        </div>
                                    </div>

                                    <div className="mt-6"></div>
                                    <h3 className="font-bold text-lg text-blue-800 mb-3 border-b border-blue-200 pb-1 uppercase text-xs tracking-wider">Dynamic Function</h3>
                                    <div className="mb-4">
                                        <span className="font-semibold text-gray-800 text-sm">Knee Drive: </span>
                                        <div className="ml-2 text-sm text-gray-900">
                                            {formData.knee_drive_right_active && (
                                            <div className="mb-1"><span className="font-medium">Right Fwd:</span> {(formData.knee_drive || []).filter(x => x.includes('Right Knee') || x.includes('Points Left') || x.includes('Right Foot')).join(', ') || 'Checked'}</div>
                                            )}
                                            {formData.knee_drive_left_active && (
                                            <div><span className="font-medium">Left Fwd:</span> {(formData.knee_drive || []).filter(x => x.includes('Left Knee') || x.includes('Points Right') || x.includes('Left Foot')).join(', ') || 'Checked'}</div>
                                            )}
                                        </div>
                                    </div>
                                    <h4 className="font-bold text-gray-700 text-sm border-b pb-1 mb-2">Walking Gait Observations {formData.gait_wfl && <span className="ml-2 bg-green-100 text-green-700 px-1.5 py-0.5 rounded text-xs">WFL</span>}</h4>
                                    <div className="grid grid-cols-2 gap-x-4">
                                        <ReadOnlyGait label="Trunk Lean" val={formData.gait_trunk} sev={formData.gait_trunk_severity} />
                                        <ReadOnlyGait label="Arm Swing" val={formData.gait_arm} sev={formData.gait_arm_severity} />
                                        <ReadOnlyGait label="Antalgic" val={formData.gait_antalgic} sev={formData.gait_antalgic_severity} />
                                        <ReadOnlyGait label="Cross-over" val={formData.gait_crossover} sev={formData.gait_crossover_severity} />
                                        <ReadOnlyGait label="Pelvic Drop" val={formData.gait_pelvic} sev={formData.gait_pelvic_severity} />
                                        <ReadOnlyGait label="Knee Trans" val={formData.gait_knee} sev={formData.gait_knee_severity} />
                                    </div>

                                    <div className="mt-6"></div>
                                    <h3 className="font-bold text-lg text-blue-800 mb-3 border-b border-blue-200 pb-1 uppercase text-xs tracking-wider">Neurology</h3>
                                    {formData.neuro_all_intact && <div className="mb-3 font-bold text-green-700">✓ All Intact</div>}
                                    {formData.neuro_intact_except && <div className="mb-3 font-bold text-amber-700">⚠ All Intact except below:</div>}
                                    
                                    <div className="mb-4 text-sm">
                                        <div className="grid grid-cols-3 font-bold border-b border-gray-300 pb-1 mb-1"><div>Level</div><div>Right</div><div>Left</div></div>
                                        {['L2','L3','L4','L5','S1'].map(lvl => {
                                            const r = formData[`myotome_${lvl}_R`];
                                            const l = formData[`myotome_${lvl}_L`];
                                            if(!r && !l) return null;
                                            return <div key={lvl} className="grid grid-cols-3 py-1 border-b border-gray-100"><div className="font-semibold">{lvl}</div><div>{r || '-'}</div><div>{l || '-'}</div></div>
                                        })}
                                    </div>
                                    <p className="text-sm text-gray-800 italic whitespace-pre-wrap">{formData.neuro_notes}</p>
                                </div>

                                {/* Column 2 */}
                                <div className="print:mt-4">
                                    <h3 className="font-bold text-lg text-blue-800 mb-3 border-b border-blue-200 pb-1 uppercase text-xs tracking-wider">Hip & Lower Extremity</h3>
                                    <ReadOnlyToeTouch thoracic={formData.toe_touch_thoracic} lumbar={formData.toe_touch_lumbar} sacrum={formData.toe_touch_sacrum} />
                                    
                                    <div className="bg-gray-50 p-2 rounded print:bg-transparent print:p-0">
                                        <ReadOnlyDual label="Log Roll" rVal={formData.hip_logroll_R} lVal={formData.hip_logroll_L} />
                                        <ReadOnlyDual label="Hip Flexion" rVal={formData.hip_flex_R} lVal={formData.hip_flex_L} rWfl={formData.hip_flex_R_wfl} lWfl={formData.hip_flex_L_wfl} />
                                        <ReadOnlyDual label="IR @ 90 of HF" rVal={formData.hip_ir_R} lVal={formData.hip_ir_L} rWfl={formData.hip_ir_R_wfl} lWfl={formData.hip_ir_L_wfl} />
                                        <ReadOnlyDual label="ER @ 90 of HF" rVal={formData.hip_er_R} lVal={formData.hip_er_L} rWfl={formData.hip_er_R_wfl} lWfl={formData.hip_er_L_wfl} />
                                        <ReadOnlyDual label="Hip Quadrant" rVal={formData.hip_quadrant_R} lVal={formData.hip_quadrant_L} /> {/* Added Hip Quadrant Preview */}
                                        <ReadOnlyDual label="Ober Test" rVal={formData.ober_R} lVal={formData.ober_L} />
                                        <ReadOnlyDual label="Thomas Test" rVal={formData.thomas_R} lVal={formData.thomas_L} />
                                        <ReadOnlyDual label="Prone Quad" rVal={formData.prone_quad_R} lVal={formData.prone_quad_L} />
                                    </div>

                                    <div className="mt-4">
                                        <h4 className="font-bold text-lg text-blue-800 mb-3 border-b border-blue-200 pb-1 uppercase text-xs tracking-wider">Hip Strength and Leg Length</h4>
                                        <ReadOnlyDual label="Prone Hamstring" rVal={formData.ham_str_R} lVal={formData.ham_str_L} rWfl={formData.ham_str_R_wfl} lWfl={formData.ham_str_L_wfl} />
                                        <ReadOnlyDual label="Hip ABD" rVal={formData.hip_abd_str_R} lVal={formData.hip_abd_str_L} rWfl={formData.hip_abd_str_R_wfl} lWfl={formData.hip_abd_str_L_wfl} />
                                        
                                        <div className="mb-2 text-sm border-t border-gray-100 pt-2 break-inside-avoid">
                                            <div className="font-semibold text-gray-800 flex items-center gap-2">Leg Length Discrepancy</div>
                                            <div className="flex items-center gap-4 mt-1">
                                                {formData.leg_len_mm && <span><span className="font-bold">{formData.leg_len_mm}</span> mm</span>}
                                                {formData.leg_len_side_R && <span className="bg-gray-100 px-2 py-0.5 rounded text-xs">Right Long</span>}
                                                {formData.leg_len_side_L && <span className="bg-gray-100 px-2 py-0.5 rounded text-xs">Left Long</span>}
                                                {formData.leg_len_sym && <span className="bg-green-100 text-green-800 px-2 py-0.5 rounded text-xs">Symmetrical</span>}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mt-4">
                                        <h4 className="font-bold text-xs text-gray-500 uppercase mb-2">Ankle / Foot</h4>
                                        <ReadOnlyForefoot rOri={formData.forefoot_R_orientation} rSev={formData.forefoot_R_severity} lOri={formData.forefoot_L_orientation} lSev={formData.forefoot_L_severity} />
                                        
                                        <h4 className="font-bold text-xs text-gray-500 uppercase mb-2 mt-4">Range of Motion</h4>
                                        <ReadOnlyDual label="DF (Knee Bent)" rVal={formData.df_prom_kb_R} lVal={formData.df_prom_kb_L} suffix="Degrees" />
                                        <ReadOnlyDual label="FF ABD (Max DF)" rVal={formData.ff_abd_max_df_R} lVal={formData.ff_abd_max_df_L} suffix="Degrees" />
                                        
                                        <div className="mt-2 border-t pt-2">
                                            <ReadOnlyMobility label="Calcaneal-Cuboid" r={formData.mobility_calc_cuboid_R} l={formData.mobility_calc_cuboid_L} />
                                            <ReadOnlyMobility label="Plantar Flex + ABD" r={formData.mobility_pf_abd_R} l={formData.mobility_pf_abd_L} />
                                            <ReadOnlyMobility label="4th/5th Meta DF" r={formData.mobility_45_meta_df_R} l={formData.mobility_45_meta_df_L} />
                                            <ReadOnlyMobility label="1st MTP Ext" r={formData.mobility_1st_mtp_ext_R} l={formData.mobility_1st_mtp_ext_L} />
                                        </div>
                                        <div className="mt-2 border-t pt-2">
                                            <ReadOnlyDual label="Dorsi-Flexion" rVal={formData.ankle_df_str_R} lVal={formData.ankle_df_str_L} rWfl={formData.ankle_df_str_R_wfl} lWfl={formData.ankle_df_str_L_wfl} />
                                            <ReadOnlyDual label="Eversion" rVal={formData.ankle_ev_str_R} lVal={formData.ankle_ev_str_L} rWfl={formData.ankle_ev_str_R_wfl} lWfl={formData.ankle_ev_str_L_wfl} />
                                            <ReadOnlyDual label="Inversion" rVal={formData.ankle_inv_str_R} lVal={formData.ankle_inv_str_L} rWfl={formData.ankle_inv_str_R_wfl} lWfl={formData.ankle_inv_str_L_wfl} />
                                            <ReadOnlyDual label="1st Ray PF" rVal={formData.ray_pf_str_R} lVal={formData.ray_pf_str_L} rWfl={formData.ray_pf_str_R_wfl} lWfl={formData.ray_pf_str_L_wfl} />
                                        </div>
                                    </div>

                                    {/* Upper Body at End */}
                                    <div className="mt-6 border-t pt-4">
                                        <h3 className="font-bold text-lg text-blue-800 mb-3 border-b border-blue-200 pb-1 uppercase text-xs tracking-wider">Upper Body & Neck</h3>
                                        <div className="bg-gray-50 p-2 rounded print:bg-transparent print:p-0">
                                            <h4 className="font-bold text-xs text-gray-500 uppercase mb-2">Cervical ROM</h4>
                                            <ReadOnlySingle label="Flexion" val={formData.neck_flexion} wfl={formData.neck_flexion_wfl} suffix="Degrees" />
                                            <ReadOnlySingle label="Right Rotation" val={formData.neck_r_rotation} wfl={formData.neck_r_rotation_wfl} suffix="Degrees" />
                                            <ReadOnlySingle label="Left Rotation" val={formData.neck_l_rotation} wfl={formData.neck_l_rotation_wfl} suffix="Degrees" />
                                            <ReadOnlySingle label="Extension" val={formData.neck_extension} wfl={formData.neck_extension_wfl} suffix="Degrees" />
                                            
                                            <h4 className="font-bold text-xs text-gray-500 uppercase mb-2 mt-4">Upper Extremity ROM</h4>
                                            <ReadOnlyDual label="ER @ 90˚ FF" rVal={formData.ue_er_90_R} lVal={formData.ue_er_90_L} rWfl={formData.ue_er_90_R_wfl} lWfl={formData.ue_er_90_L_wfl} suffix="Degrees" />
                                            <ReadOnlyDual label="Fwd Flexion" rVal={formData.ue_fwd_flex_R} lVal={formData.ue_fwd_flex_L} rWfl={formData.ue_fwd_flex_R_wfl} lWfl={formData.ue_fwd_flex_L_wfl} suffix="Degrees" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* PROBLEM LIST SECTION */}
                            <ProblemList data={formData} />

                            <div className="mt-12 pt-4 border-t border-gray-300 text-center text-xs text-gray-400 print:block hidden">
                                Generated via Biomechanics Digital Exam • {new Date().toLocaleDateString()}
                            </div>
                        </div>

                        {/* Floating Action Buttons */}
                        <div className="fixed bottom-6 right-6 flex flex-col gap-3 no-print z-50">
                            <button onClick={() => window.print()} className="flex items-center gap-2 bg-slate-800 text-white px-6 py-4 rounded-full shadow-xl hover:bg-slate-700 transition-all font-bold">
                                <Icon name="printer" /> Save as PDF / Print
                            </button>
                            <button onClick={() => setMode('edit')} className="flex items-center gap-2 bg-white text-slate-800 px-6 py-4 rounded-full shadow-lg hover:bg-gray-50 transition-all font-bold">
                                <Icon name="edit-3" /> Edit Form
                            </button>
                        </div>
                    </div>
                );
            }

            // --- VIEW: EDIT ---
            return (
                <div className="min-h-screen bg-gray-50 pb-24">
                    <div className="bg-slate-900 text-white p-6 shadow-md sticky top-0 z-50 no-print">
                        <div className="max-w-3xl mx-auto flex justify-between items-center">
                            <h1 className="text-xl font-bold flex items-center gap-2">
                                <Icon name="activity" className="text-blue-400" />
                                Biomechanics Exam
                            </h1>
                            <button onClick={clearForm} className="text-xs bg-slate-800 px-3 py-1 rounded hover:bg-red-900 transition-colors">Clear</button>
                        </div>
                    </div>

                    <div className="max-w-3xl mx-auto p-4 md:p-6">
                        <div className="bg-white rounded-lg shadow-sm p-4 mb-4 border-l-4 border-blue-500">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Date</label>
                                    <input type="date" value={formData.date} onChange={(e) => handleChange('date', e.target.value)} className="w-full p-2 bg-gray-50 rounded border border-gray-200 font-medium" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Initials / Client ID</label>
                                    <input type="text" value={formData.initials} onChange={(e) => handleChange('initials', e.target.value)} placeholder="e.g. JD" className="w-full p-2 bg-gray-50 rounded border border-gray-200 font-medium" />
                                </div>
                            </div>
                        </div>

                        {/* Section 1 */}
                        <SectionHeader title="Standing Posture" iconName="user" isOpen={expandedSections.posture} toggle={() => toggleSection('posture')} />
                        {expandedSections.posture && (
                            <div className="bg-white p-4 rounded-b-lg shadow-sm">
                                <QualifiedCheckboxGroup label="Head" name="head_posture" data={formData} onChange={handleChange} options={['Neutral', 'Forward']} />
                                <QualifiedCheckboxGroup label="Thoracic" name="thoracic_posture" data={formData} onChange={handleChange} options={['Neutral', 'Kyphosis', 'Flat']} />
                                <QualifiedCheckboxGroup label="Scapula Position" name="scapula_posture" data={formData} onChange={handleChange} options={['Left High', 'Right High']} />
                                <QualifiedCheckboxGroup label="Lateral Shift" name="lateral_shift" data={formData} onChange={handleChange} options={['Right', 'Left']} />
                                <QualifiedCheckboxGroup label="Lumbar" name="lumbar_posture" data={formData} onChange={handleChange} options={['Neutral', 'Lordotic', 'Swayback']} />
                                <div className="border-t border-gray-100 my-4 pt-4">
                                    <label className="block text-sm font-bold text-gray-800 mb-2 uppercase tracking-wide">Pelvis</label>
                                    <QualifiedCheckboxGroup label="ASIS Position" name="asis_position" data={formData} onChange={handleChange} options={['Right High', 'Left High']} />
                                    <QualifiedCheckboxGroup label="PSIS Position" name="psis_position" data={formData} onChange={handleChange} options={['Left High', 'Right High']} />
                                </div>
                                <div className="border-t border-gray-100 my-4 pt-4">
                                    <label className="block text-sm font-bold text-gray-800 mb-2 uppercase tracking-wide">Knees</label>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-xs font-semibold text-gray-500 mb-1">Right Knee</div>
                                            <QualifiedCheckboxGroup label="" name="knees_posture_R" data={formData} onChange={handleChange} options={['Neutral', 'Valgus', 'Varus']} />
                                        </div>
                                        <div>
                                            <div className="text-xs font-semibold text-gray-500 mb-1">Left Knee</div>
                                            <QualifiedCheckboxGroup label="" name="knees_posture_L" data={formData} onChange={handleChange} options={['Neutral', 'Valgus', 'Varus']} />
                                        </div>
                                    </div>
                                </div>
                                <div className="border-t border-gray-100 my-4 pt-4">
                                    <label className="block text-sm font-bold text-gray-800 mb-2 uppercase tracking-wide">Feet / Arch</label>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <div className="text-xs font-semibold text-gray-500 mb-1">Right Foot</div>
                                            <QualifiedCheckboxGroup label="" name="arch_posture_R" data={formData} onChange={handleChange} options={['Neutral', 'High', 'Low', 'Flat']} />
                                        </div>
                                        <div>
                                            <div className="text-xs font-semibold text-gray-500 mb-1">Left Foot</div>
                                            <QualifiedCheckboxGroup label="" name="arch_posture_L" data={formData} onChange={handleChange} options={['Neutral', 'High', 'Low', 'Flat']} />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Section 2 */}
                        <SectionHeader title="Dynamic & Gait" iconName="activity" isOpen={expandedSections.dynamic} toggle={() => toggleSection('dynamic')} />
                        {expandedSections.dynamic && (
                            <div className="bg-white p-4 rounded-b-lg shadow-sm">
                                <h4 className="font-bold text-gray-800 mb-3 border-b pb-1">Driving Knees Forward</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div className="bg-blue-50 p-3 rounded">
                                        <label className="flex items-center gap-2 font-bold text-sm text-blue-900 mb-2 uppercase cursor-pointer">
                                            <input type="checkbox" checked={formData.knee_drive_right_active || false} onChange={(e) => handleChange('knee_drive_right_active', e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                            Right Knee Forward
                                        </label>
                                        <div className="flex flex-col gap-2 pl-6 border-l-2 border-blue-200 ml-2">
                                            {['Pelvis Points Left', 'Right Foot Collapses'].map(opt => (
                                                <label key={opt} className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                                    <input type="checkbox" checked={(formData.knee_drive || []).includes(opt)} onChange={(e) => { const current = formData.knee_drive || []; const updated = e.target.checked ? [...current, opt] : current.filter(x => x !== opt); handleChange('knee_drive', updated); }} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                                    {opt}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-blue-50 p-3 rounded">
                                        <label className="flex items-center gap-2 font-bold text-sm text-blue-900 mb-2 uppercase cursor-pointer">
                                            <input type="checkbox" checked={formData.knee_drive_left_active || false} onChange={(e) => handleChange('knee_drive_left_active', e.target.checked)} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                            Left Knee Forward
                                        </label>
                                        <div className="flex flex-col gap-2 pl-6 border-l-2 border-blue-200 ml-2">
                                            {['Pelvis Points Right', 'Left Foot Collapses'].map(opt => (
                                                <label key={opt} className="flex items-center gap-2 text-sm cursor-pointer select-none">
                                                    <input type="checkbox" checked={(formData.knee_drive || []).includes(opt)} onChange={(e) => { const current = formData.knee_drive || []; const updated = e.target.checked ? [...current, opt] : current.filter(x => x !== opt); handleChange('knee_drive', updated); }} className="w-4 h-4 text-blue-600 rounded focus:ring-blue-500" />
                                                    {opt}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="flex items-center justify-between mt-4 mb-3 border-b pb-1">
                                    <h4 className="font-bold text-gray-800">Walking Gait Observations</h4>
                                    <WFLCheckbox label="Within Functional Limits" checked={formData.gait_wfl} onChange={(val) => handleChange('gait_wfl', val)} />
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-x-4">
                                    <GaitObservationRow label="Trunk Lean" name="gait_trunk" data={formData} onChange={handleChange} />
                                    <GaitObservationRow label="Arm Swing" name="gait_arm" data={formData} onChange={handleChange} />
                                    <GaitObservationRow label="Antalgic?" name="gait_antalgic" data={formData} onChange={handleChange} />
                                    <GaitObservationRow label="Cross-over" name="gait_crossover" data={formData} onChange={handleChange} />
                                    <GaitObservationRow label="Pelvic Drop" name="gait_pelvic" data={formData} onChange={handleChange} />
                                    <GaitObservationRow label="Knee Trans" name="gait_knee" data={formData} onChange={handleChange} />
                                </div>
                            </div>
                        )}

                        {/* Section 3 */}
                        <SectionHeader title="Neurology" iconName="clipboard-list" isOpen={expandedSections.neuro} toggle={() => toggleSection('neuro')} />
                        {expandedSections.neuro && (
                            <div className="bg-white p-4 rounded-b-lg shadow-sm">
                                <div className="mb-6 p-3 bg-gray-50 rounded border border-gray-100 flex flex-col sm:flex-row gap-4">
                                    <label className="flex items-center gap-2 font-bold text-gray-800 cursor-pointer select-none">
                                        <input type="checkbox" checked={formData.neuro_all_intact || false} onChange={(e) => { handleChange('neuro_all_intact', e.target.checked); if(e.target.checked) handleChange('neuro_intact_except', false); }} className="w-5 h-5 text-green-600 rounded focus:ring-green-500" />
                                        All Intact
                                    </label>
                                    <label className="flex items-center gap-2 font-bold text-gray-800 cursor-pointer select-none">
                                        <input type="checkbox" checked={formData.neuro_intact_except || false} onChange={(e) => { handleChange('neuro_intact_except', e.target.checked); if(e.target.checked) handleChange('neuro_all_intact', false); }} className="w-5 h-5 text-amber-600 rounded focus:ring-amber-500" />
                                        All Intact except below
                                    </label>
                                </div>
                                <h4 className="font-bold text-gray-800 mb-3 border-b pb-1">Lower Extremity Myotomes</h4>
                                <div className="grid grid-cols-12 gap-2 font-bold text-xs text-gray-500 uppercase tracking-wider mb-2 text-center">
                                    <div className="col-span-2">Level</div>
                                    <div className="col-span-5 text-left pl-2">Right</div>
                                    <div className="col-span-5 text-left pl-2">Left</div>
                                </div>
                                <MyotomeRow level="L2" data={formData} onChange={handleChange} />
                                <MyotomeRow level="L3" data={formData} onChange={handleChange} />
                                <MyotomeRow level="L4" data={formData} onChange={handleChange} />
                                <MyotomeRow level="L5" data={formData} onChange={handleChange} />
                                <MyotomeRow level="S1" data={formData} onChange={handleChange} />
                                <label className="block text-sm font-semibold text-gray-700 mt-4 mb-2">Other Neuro Notes (Reflexes/Dermatomes)</label>
                                <textarea className="w-full p-3 border border-gray-300 rounded-md h-24 focus:ring-2 focus:ring-blue-500 outline-none" value={formData.neuro_notes} onChange={(e) => handleChange('neuro_notes', e.target.value)}></textarea>
                            </div>
                        )}

                        {/* Section 4 */}
                        <SectionHeader title="Hip & Functional Mobility" iconName="user" isOpen={expandedSections.mobility} toggle={() => toggleSection('mobility')} />
                        {expandedSections.mobility && (
                            <div className="bg-white p-4 rounded-b-lg shadow-sm">
                                <div className="mb-6 p-4 bg-gray-50 rounded border border-gray-100">
                                    <h4 className="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide">Toe Touch - Spinal Mobility</h4>
                                    <div className="grid grid-cols-5 gap-2 mb-2 font-bold text-[10px] uppercase text-gray-400 text-center">
                                        <div className="text-left">Segment</div><div>WFL</div><div>Mild</div><div>Mod</div><div>Sig</div>
                                    </div>
                                    <ToeTouchRow label="Thoracic" name="toe_touch_thoracic" data={formData} onChange={handleChange} />
                                    <ToeTouchRow label="Lumbar" name="toe_touch_lumbar" data={formData} onChange={handleChange} />
                                    <ToeTouchRow label="Sacrum" name="toe_touch_sacrum" data={formData} onChange={handleChange} />
                                </div>
                                <h4 className="font-bold text-gray-800 mt-6 mb-3 bg-blue-50 p-2 rounded">Hip Examination</h4>
                                <DualBinaryRow label="Log Roll" baseName="hip_logroll" data={formData} onChange={handleChange} />
                                <DualInputRow label="Hip Flexion" baseName="hip_flex" data={formData} onChange={handleChange} placeholder="deg" showWFL={true} />
                                <DualInputRow label="IR @ 90 of HF" baseName="hip_ir" data={formData} onChange={handleChange} placeholder="deg" showWFL={true} />
                                <DualInputRow label="ER @ 90 of HF" baseName="hip_er" data={formData} onChange={handleChange} placeholder="deg" showWFL={true} />
                                <DualBinaryRow label="Hip Quadrant" baseName="hip_quadrant" data={formData} onChange={handleChange} /> {/* Added Hip Quadrant */}
                                <DualBinaryRow label="Ober Test" baseName="ober" data={formData} onChange={handleChange} />
                                <DualBinaryRow label="Thomas Test" baseName="thomas" data={formData} onChange={handleChange} />
                                <DualDropdownRow label="Prone Quad Flex" baseName="prone_quad" data={formData} onChange={handleChange} customOptions={['WFL', 'Mild Dec.', 'Mod Dec.', 'Sig. Dec.']} />

                                <h4 className="font-bold text-gray-800 mt-6 mb-3 bg-blue-50 p-2 rounded">Hip Strength and Leg Length</h4>
                                <DualDropdownRow label="Prone Hamstring" baseName="ham_str" data={formData} onChange={handleChange} showWFL={true} />
                                <DualDropdownRow label="Hip ABD" baseName="hip_abd_str" data={formData} onChange={handleChange} showWFL={true} />
                                
                                <div className="mb-3 flex flex-col md:flex-row gap-2 items-center border-b border-gray-100 pb-2 md:pb-0 md:border-0 pt-2">
                                    <div className="md:w-1/4">
                                        <label className="text-sm font-medium text-gray-700">Leg Length Diff</label>
                                    </div>
                                    <div className="md:w-3/4 flex items-center gap-4">
                                        <input
                                            type="text"
                                            className="w-24 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 outline-none"
                                            placeholder="mm"
                                            value={formData.leg_len_mm || ''}
                                            onChange={(e) => handleChange('leg_len_mm', e.target.value)}
                                        />
                                        <div className="flex gap-2 text-sm">
                                            <label className="flex items-center gap-1"><input type="checkbox" checked={formData.leg_len_side_R} onChange={(e) => handleChange('leg_len_side_R', e.target.checked)} /> Right</label>
                                            <label className="flex items-center gap-1"><input type="checkbox" checked={formData.leg_len_side_L} onChange={(e) => handleChange('leg_len_side_L', e.target.checked)} /> Left</label>
                                            <label className="flex items-center gap-1"><input type="checkbox" checked={formData.leg_len_sym} onChange={(e) => handleChange('leg_len_sym', e.target.checked)} /> Symmetrical</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Section 5 */}
                        <SectionHeader title="Foot & Ankle" iconName="user" isOpen={expandedSections.foot} toggle={() => toggleSection('foot')} />
                        {expandedSections.foot && (
                            <div className="bg-white p-4 rounded-b-lg shadow-sm">
                                <h4 className="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded">Forefoot Orientation</h4>
                                <ForefootRow label="Right" side="R" data={formData} onChange={handleChange} />
                                <ForefootRow label="Left" side="L" data={formData} onChange={handleChange} />
                                <h4 className="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded mt-4">Ankle Orientation & Mobility</h4>
                                <DualMobilityRow label="Calcaneal-Cuboid" baseName="mobility_calc_cuboid" data={formData} onChange={handleChange} />
                                <DualMobilityRow label="Plantar Flexion + ABD" baseName="mobility_pf_abd" data={formData} onChange={handleChange} />
                                <DualMobilityRow label="4th & 5th Metatarsal DF" baseName="mobility_45_meta_df" data={formData} onChange={handleChange} />
                                <DualMobilityRow label="1st MTP Extension" baseName="mobility_1st_mtp_ext" data={formData} onChange={handleChange} />
                                <h4 className="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded mt-4">Range of Motion</h4>
                                <DualInputRow label="DF PROM (Knee Bent)" baseName="df_prom_kb" data={formData} onChange={handleChange} placeholder="deg" suffix="Degrees" />
                                <DualInputRow label="FF ABD (Max DF)" baseName="ff_abd_max_df" data={formData} onChange={handleChange} placeholder="deg" suffix="Degrees" />
                                <h4 className="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded mt-4">Strength (/5)</h4>
                                <DualDropdownRow label="Dorsi-Flexion" baseName="ankle_df_str" data={formData} onChange={handleChange} showWFL={true} />
                                <DualDropdownRow label="Eversion" baseName="ankle_ev_str" data={formData} onChange={handleChange} showWFL={true} />
                                <DualDropdownRow label="Inversion" baseName="ankle_inv_str" data={formData} onChange={handleChange} showWFL={true} />
                                <DualDropdownRow label="1st Ray PF" baseName="ray_pf_str" data={formData} onChange={handleChange} showWFL={true} />
                            </div>
                        )}

                        {/* Section 6 (Last) */}
                        <SectionHeader title="Upper Body & Neck" iconName="user" isOpen={expandedSections.upper} toggle={() => toggleSection('upper')} />
                        {expandedSections.upper && (
                            <div className="bg-white p-4 rounded-b-lg shadow-sm">
                                <h4 className="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded">Cervical ROM</h4>
                                <SingleInputRow label="Flexion" baseName="neck_flexion" data={formData} onChange={handleChange} showWFL={true} suffix="Degrees" />
                                <SingleInputRow label="Right Rotation" baseName="neck_r_rotation" data={formData} onChange={handleChange} showWFL={true} suffix="Degrees" />
                                <SingleInputRow label="Left Rotation" baseName="neck_l_rotation" data={formData} onChange={handleChange} showWFL={true} suffix="Degrees" />
                                <SingleInputRow label="Extension" baseName="neck_extension" data={formData} onChange={handleChange} showWFL={true} suffix="Degrees" />
                                <h4 className="font-bold text-gray-800 mb-3 bg-blue-50 p-2 rounded mt-6">Upper Extremity ROM</h4>
                                <DualInputRow label="ER @ 90˚ FF" baseName="ue_er_90" data={formData} onChange={handleChange} placeholder="deg" showWFL={true} suffix="Degrees" />
                                <DualInputRow label="Forward Flexion" baseName="ue_fwd_flex" data={formData} onChange={handleChange} placeholder="deg" showWFL={true} suffix="Degrees" />
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-6 right-6 no-print">
                        <button 
                            onClick={() => { window.scrollTo(0,0); setMode('preview'); }}
                            className="flex items-center gap-2 bg-blue-600 text-white px-6 py-4 rounded-full shadow-xl hover:bg-blue-500 transition-all font-bold text-lg"
                        >
                            <Icon name="file-text" size={24} />
                            Preview Report
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BiomechanicsExam />);
    </script>
</body>
</html>